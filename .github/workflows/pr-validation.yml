name: PR Validation

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: "20"
  # Ensure consistent environment
  NPM_CONFIG_CACHE: ~/.npm
  FORCE_COLOR: 2

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    steps:
      - name: PR Info
        run: |
          echo "### Pull Request Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Version**: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Files changed**: Calculating..." >> $GITHUB_STEP_SUMMARY

  size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          # Compter les lignes modifiÃ©es
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          CHANGED_FILES=$(git diff --name-only $BASE_SHA..$HEAD_SHA | wc -l)
          ADDED_LINES=$(git diff --numstat $BASE_SHA..$HEAD_SHA | awk '{sum += $1} END {print sum}')
          REMOVED_LINES=$(git diff --numstat $BASE_SHA..$HEAD_SHA | awk '{sum += $2} END {print sum}')

          echo "### PR Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Files changed**: $CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Lines added**: $ADDED_LINES" >> $GITHUB_STEP_SUMMARY
          echo "- **Lines removed**: $REMOVED_LINES" >> $GITHUB_STEP_SUMMARY

          # Seuils diffÃ©rents selon la branche cible
          if [ "${{ github.base_ref }}" = "main" ]; then
            FILE_THRESHOLD=50
            LINE_THRESHOLD=1000
            echo "- **Context**: Merge to main (relaxed thresholds)" >> $GITHUB_STEP_SUMMARY
          else
            FILE_THRESHOLD=20
            LINE_THRESHOLD=500
            echo "- **Context**: Feature branch (standard thresholds)" >> $GITHUB_STEP_SUMMARY
          fi

          # Alerte si la PR est trop grosse
          if [ $CHANGED_FILES -gt $FILE_THRESHOLD ] || [ $ADDED_LINES -gt $LINE_THRESHOLD ]; then
            echo "âš ï¸ **Large PR detected!** Consider breaking it into smaller chunks." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Good PR size!**" >> $GITHUB_STEP_SUMMARY
          fi

  conventional-commits:
    name: Conventional Commits Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit messages
        run: |
          echo "### Commit Message Validation" >> $GITHUB_STEP_SUMMARY

          # Pattern pour conventional commits
          PATTERN="^(feat|fix|docs|style|refactor|test|chore|ci|perf|build|revert)(\(.+\))?: .{1,50}"

          # VÃ©rifier chaque commit dans la PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          INVALID_COMMITS=0
          while IFS= read -r commit; do
            if ! echo "$commit" | grep -qE "$PATTERN"; then
              echo "âŒ Invalid commit: $commit" >> $GITHUB_STEP_SUMMARY
              INVALID_COMMITS=$((INVALID_COMMITS + 1))
            fi
          done < <(git log --format="%s" $BASE_SHA..$HEAD_SHA)

          if [ $INVALID_COMMITS -eq 0 ]; then
            echo "âœ… All commits follow conventional commit format!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ $INVALID_COMMITS commits don't follow conventional format" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Expected format**: \`type(scope): description\`" >> $GITHUB_STEP_SUMMARY
            echo "**Types**: feat, fix, docs, style, refactor, test, chore, ci, perf, build, revert" >> $GITHUB_STEP_SUMMARY
          fi

  changed-files:
    name: Changed Files Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze changed files
        run: |
          echo "### Changed Files Analysis" >> $GITHUB_STEP_SUMMARY

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Analyser les types de fichiers modifiÃ©s
          echo "#### File Types Changed:" >> $GITHUB_STEP_SUMMARY
          git diff --name-only $BASE_SHA..$HEAD_SHA | sed 's/.*\.//' | sort | uniq -c | while read count ext; do
            echo "- **.$ext**: $count files" >> $GITHUB_STEP_SUMMARY
          done

          # VÃ©rifier si des fichiers critiques ont Ã©tÃ© modifiÃ©s
          CRITICAL_FILES="package.json package-lock.json vite.config.ts tsconfig.json .github/"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Critical Files Check:" >> $GITHUB_STEP_SUMMARY

          CRITICAL_CHANGED=false
          for file in $CRITICAL_FILES; do
            if git diff --name-only $BASE_SHA..$HEAD_SHA | grep -q "^$file"; then
              echo "âš ï¸ **$file** has been modified" >> $GITHUB_STEP_SUMMARY
              CRITICAL_CHANGED=true
            fi
          done

          if [ "$CRITICAL_CHANGED" = false ]; then
            echo "âœ… No critical configuration files modified" >> $GITHUB_STEP_SUMMARY
          fi

  build-validation:
    name: Build Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Clean npm cache
        run: npm cache verify

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit --progress=false
          echo "### Build Environment" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js**: $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **npm**: $(npm --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: $(uname -a)" >> $GITHUB_STEP_SUMMARY

      - name: Type check
        run: |
          echo "### TypeScript Compilation" >> $GITHUB_STEP_SUMMARY
          if npx tsc --noEmit; then
            echo "âœ… TypeScript compilation successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ TypeScript compilation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Build PR version
        run: |
          echo "### Build Process" >> $GITHUB_STEP_SUMMARY
          if npm run build; then
            echo "âœ… Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Get PR build size
        id: pr-size
        run: |
          PR_SIZE=$(du -sb dist | cut -f1)
          echo "size=$PR_SIZE" >> $GITHUB_OUTPUT

  build-diff:
    name: Build Size Comparison
    runs-on: ubuntu-latest
    needs: build-validation
    steps:
      - name: Determine comparison base
        id: comparison-base
        run: |
          if [ "${{ github.base_ref }}" = "main" ]; then
            # Pour les merges vers main, essayer de comparer avec le dernier tag
            COMPARISON_REF=$(git ls-remote --tags origin | grep -v '\^{}' | sort -V | tail -1 | cut -f2 | sed 's/refs\/tags\///' 2>/dev/null || echo "main")
            echo "ref=$COMPARISON_REF" >> $GITHUB_OUTPUT
            echo "context=merge-to-main" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ github.base_ref }}" >> $GITHUB_OUTPUT
            echo "context=feature-branch" >> $GITHUB_OUTPUT
          fi

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.comparison-base.outputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Install dependencies (base)
        run: npm ci --prefer-offline --no-audit --progress=false

      - name: Build base version
        run: npm run build

      - name: Get base build size
        id: base-size
        run: |
          BASE_SIZE=$(du -sb dist | cut -f1)
          echo "size=$BASE_SIZE" >> $GITHUB_OUTPUT

      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Node.js (PR)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Install dependencies (PR)
        run: npm ci --prefer-offline --no-audit --progress=false

      - name: Build PR version
        run: npm run build

      - name: Compare build sizes
        run: |
          BASE_SIZE=${{ steps.base-size.outputs.size }}
          PR_SIZE=$(du -sb dist | cut -f1)
          CONTEXT="${{ steps.comparison-base.outputs.context }}"
          COMPARISON_REF="${{ steps.comparison-base.outputs.ref }}"

          # Calculer la diffÃ©rence
          DIFF=$((PR_SIZE - BASE_SIZE))
          DIFF_PERCENT=$(echo "scale=2; ($DIFF * 100) / $BASE_SIZE" | bc -l)

          echo "### ðŸ“Š Build Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Comparison base**: $COMPARISON_REF" >> $GITHUB_STEP_SUMMARY
          echo "- **Base build**: $(echo $BASE_SIZE | awk '{print int($1/1024/1024) " MB (" int($1/1024) " KB)"}')" >> $GITHUB_STEP_SUMMARY
          echo "- **PR build**: $(echo $PR_SIZE | awk '{print int($1/1024/1024) " MB (" int($1/1024) " KB)"}')" >> $GITHUB_STEP_SUMMARY
          echo "- **Difference**: $(echo $DIFF | awk '{if($1>=0) print "+" int($1/1024) " KB"; else print int($1/1024) " KB"}') (${DIFF_PERCENT}%)" >> $GITHUB_STEP_SUMMARY

          # Seuils diffÃ©rents selon le contexte
          if [ "$CONTEXT" = "merge-to-main" ]; then
            THRESHOLD=500000  # 500KB - Plus tolÃ©rant pour develop -> main
            echo "- **Context**: Merge to main (relaxed threshold: 500KB)" >> $GITHUB_STEP_SUMMARY
            
            if [ $DIFF -gt $THRESHOLD ]; then
              echo "âš ï¸ **Significant build size increase detected!**" >> $GITHUB_STEP_SUMMARY
              echo "This may be expected when merging develop into main with new features." >> $GITHUB_STEP_SUMMARY
              echo "Please review if this increase is justified by the new functionality." >> $GITHUB_STEP_SUMMARY
            elif [ $DIFF -lt -50000 ]; then  # < -50KB
              echo "ðŸŽ‰ **Great! Build size decreased!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **Build size change is acceptable for a main merge**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            THRESHOLD=100000  # 100KB - Plus strict pour les feature branches
            echo "- **Context**: Feature branch (standard threshold: 100KB)" >> $GITHUB_STEP_SUMMARY
            
            if [ $DIFF -gt $THRESHOLD ]; then
              echo "âš ï¸ **Significant build size increase detected!**" >> $GITHUB_STEP_SUMMARY
              echo "Consider reviewing the changes to reduce bundle size." >> $GITHUB_STEP_SUMMARY
            elif [ $DIFF -lt -50000 ]; then  # < -50KB
              echo "ðŸŽ‰ **Great! Build size decreased!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **Build size change is acceptable**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
